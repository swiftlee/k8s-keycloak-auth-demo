apiVersion: apps/v1
kind: Deployment
metadata:
  name: istio-ingressgateway
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  template:
    metadata:
      annotations:
        # Select the gateway injection template (rather than the default sidecar template)
        inject.istio.io/templates: gateway
      labels:
        # Set a unique label for the gateway. This is required to ensure Gateways can select this workload
        istio: ingressgateway
        # Enable gateway injection. If connecting to a revisioned control plane, replace with "istio.io/rev: revision-name"
        sidecar.istio.io/inject: "true"
    spec:
      # Allow binding to all ports (such as 80 and 443)
      securityContext:
        sysctls:
          - name: net.ipv4.ip_unprivileged_port_start
            value: "0"
      containers:
        - name: istio-proxy
          image: auto
          securityContext:
            capabilities:
              drop:
                - ALL
            runAsUser: 1337
            runAsGroup: 1337
          volumeMounts:
            - name: ingressgateway-certs
              mountPath: /etc/istio/ingressgateway-certs
              readOnly: true
            - name: ca-cert
              mountPath: /etc/istio/ca-cert
              readOnly: true
      volumes:
        - name: ingressgateway-certs
          secret:
            secretName: istio-ingressgateway-certs
        - name: ca-cert
          secret:
            secretName: ca-cert
---
apiVersion: v1
kind: Service
metadata:
  name: istio-ingressgateway
  namespace: istio-system
spec:
  type: NodePort
  selector:
    istio: ingressgateway
  ports:
    - port: 80
      targetPort: 8080
      nodePort: 30080 # This will be exposed on the Kind node
      name: http
    - port: 443
      targetPort: 8443
      nodePort: 30443
      name: https
---

apiVersion: v1
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVnekNDQW11Z0F3SUJBZ0lVVGVxbHdnaDNjZHdKZHhYUlZFL2w0MkV2ZFVrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0VURVBNQTBHQTFVRUF3d0dVbTl2ZEVOQk1CNFhEVEkwTVRJeU9UQXpOVEV5TUZvWERUSTFNVEl5T1RBegpOVEV5TUZvd2J6RUxNQWtHQTFVRUJoTUNWVk14RGpBTUJnTlZCQWdNQlZOMFlYUmxNUTB3Q3dZRFZRUUhEQVJECmFYUjVNUlV3RXdZRFZRUUtEQXhQY21kaGJtbDZZWFJwYjI0eEVUQVBCZ05WQkFzTUNFOXlaeUJWYm1sME1SY3cKRlFZRFZRUUREQTVyT0hNdFpHVnRieTVzYjJOaGJEQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQwpBUW9DZ2dFQkFJaG9RYitSNHNQd3BQaWpLcHRRWlpKbXZLT0hQanA1czhpNGo3L2tvYU9lL2VHN0wxZU0xaXVlCml4bFo4U0ZlY1pOeSs5VUFIVWhqMlZmajB2ME10ampiNGozelJnMGJoNS9HRE1YUUYyM21HRTEyWE1qeXNGOEMKV0xreDdxTDhPNTVMVm9FRVpUWEZScWtqNG1xUW0zVFF2VkdRU0pPREhuVEdsSVFJUkpmWGk1UHVGM0syQTRFRgozTFN1R0NyeHlBZHFlcGtWUVZSQUdkUDZ2WVZ5RnU4aHBkbGtXTW5DUi93MHlPTXQ2TlpkckpUYWdjM1R0VWxJCm1YbFNKSzJKSHhwV2plSlNRWHN2RllHcE82QjlJU0NHcEVLZVpvK2hEWUlZU0Z5TlBpSG1BZU1KZDEyc2hxQ24KNUE2TmRFZGtNTGpoRWtQTStKZFJLbjFXTXNOVWhRa0NBd0VBQWFOMU1ITXdDUVlEVlIwVEJBSXdBREFMQmdOVgpIUThFQkFNQ0JlQXdHUVlEVlIwUkJCSXdFSUlPYXpoekxXUmxiVzh1Ykc5allXd3dIUVlEVlIwT0JCWUVGTWZUCmtuNUVuS1R1RFI5K2w5K1VtVWNZY0dtSE1COEdBMVVkSXdRWU1CYUFGSStQT3ZHRkx4NGw5KzZzcFVQdjQvUEEKcTZCY01BMEdDU3FHU0liM0RRRUJDd1VBQTRJQ0FRQ0JDUkNVcDlqdHU4TUVTbUQrOW1aS1J1TjFVak5mdFFUdApKaEl1Z2MzZFQ1MUEvSTRuZjdFVEtwd2xISmZnaFBubG9uYXYxcWNnNmxCVzRwNU5wWEFsTEkrcWhQTXNQY0c0CjJtOFFhRGNOVUZrUHhvOThGTy90cHRVS0VMTjFFTWtLdkNwYzNFVGRKQWV5WjU1VkY5S0s3MTFxUTBzNExlSkYKSnZRVEJ2ek9jMUkwOFBUZUMzVDg5c0RxRTR6bUJ5S1NUbmdUdEZaelQyNWlLS3o5ZWFyNGhjUk9QbmExb2pXdApxNURZUmxFNU5UNE5yeUh6V25sUWlMdlBLcUF4aHExK2dMN3F0UEF6NW5WK2JpYzFLQVhmMnJTZVVCdWZ0b0gvCnFsMkc2Z0ZYRHBGODBTRzFWYWZ6MnZXbklNektxbzNtYUZmUmtOWG8rZVFLeW1LaFBrZmlQSXpwak5CQVZPVHcKQ0xUWVBRdng4L2hvbnVWZDJZaFNyYmVNbmhlY3RwNFBpM3ZlN25uWmxKY0FZNUEzbkc4dnFMMkxJMEthTmNwSQpZZXhDN3pKNlBSSm53M0lMaTllMXBBMlhWQ0gwVURCRWpWWXp5NnJVZlc3Q3lQdDQyRXM5eXpzc1loRkNZM3NuCmVWMXI4YVFjRCtDREVJcU9QNDJvYk9nSHZkdVFaNHdUVzBjYW5jVUxnR2ZjOFJtNzBMMWNnb3RxT3hqZGpXdEgKcWNRZnBuZHNLOEU0TlBpb2E1NHBDQzBIWlNyL1p1MnY1djRINTA1VVk4ZTlQcFpWQkZGenNZd1UxdkpONy9PMgphRmtuekRSanJ4andFYWdIRWNBcG81Z1FmTDl5U0VZaExWK0kycmJHS1NRME41WW5DVGVqcEpaQmFFY2JxUUsxCk1PTGNKeFBxWVE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ0lhRUcva2VMRDhLVDQKb3lxYlVHV1NacnlqaHo0NmViUEl1SSsvNUtHam52M2h1eTlYak5Zcm5vc1pXZkVoWG5HVGN2dlZBQjFJWTlsWAo0OUw5RExZNDIrSTk4MFlORzRlZnhnekYwQmR0NWhoTmRsekk4ckJmQWxpNU1lNmkvRHVlUzFhQkJHVTF4VWFwCkkrSnFrSnQwMEwxUmtFaVRneDUweHBTRUNFU1gxNHVUN2hkeXRnT0JCZHkwcmhncThjZ0hhbnFaRlVGVVFCblQKK3IyRmNoYnZJYVhaWkZqSndrZjhOTWpqTGVqV1hheVUyb0hOMDdWSlNKbDVVaVN0aVI4YVZvM2lVa0Y3THhXQgpxVHVnZlNFZ2hxUkNubWFQb1EyQ0dFaGNqVDRoNWdIakNYZGRySWFncCtRT2pYUkhaREM0NFJKRHpQaVhVU3A5ClZqTERWSVVKQWdNQkFBRUNnZ0VBRW00T1ZCVWdqN0MzMldWODlZeDE3TU0zYkRESVZrWTk1WTlxSjFjbUJRd1AKbEFGM3lBWElwTGxyRHlYT2VvcGV5MlBzWlQ3NnRkNTlHRzdqckRwSGRJU0xtNEIrK25rUEUxQ1lSb2NkdUpvdgpZUktZNlYyV09ZQUEvM24yUlhjbTV2V1ppUno2Nm1UdWJjazNaNGFFNVNlVUxLejk0VkJaNW1xSTJSTktPK21QCm9xWVBWcHdFM1RubklJczNyWVJSUUlob0tRaDk5Zm5hdXo5U0lheDlYTjA3bGhsQmo3N0RxcUQ3eGtjMVE1YzIKRWJlSlB3ZmN2QUkwa3ZYNTJDREtETFFiWWVzUncrcHYxVU1rbjcyWEZEa2tNaFNnd1ZwZU1ZZVdENmpRTzY4KwpKdTlvR2d5WTQvS2VNQ0xQUmZaMWZSOERDcFVnakJPclpPbHFzcUE0Y1FLQmdRQy8zQTdFU0tvTko4d2lpcHF4CmxHcEVNd2wwYUNjRUZ5cm02c1NUejdZL0d0MkgyQnRUQ0l0Nyt5M29zU29nVjlOVE5ncytBaWdKc3hGU3A1WEkKSlhLWXNGUEN2bGtscGE2UGhiRXp5SE5jc0tPUUM3aUROTEpHR3BsRXZHK2tmemZKQkhxWDNnTmM4ZzY4WW1COQpKMCt3K0Jjc1MwSkZMeGVOYTJ0YklPRzRad0tCZ1FDMkFtb2VhU0ZwRWpkbmNpSFB1aEkxalQ5dHNNYmZMNnhkCmc0QUZOdDlNQTNPT3FhM01RQWRtUEFhVE1tMy9UbXNUcjhEZ3NNVXlNNW5udWFWNm5abFZmZGJzUmF1c2t2WXUKTGY3cU1hTkRQMWtrQU5ST0haYkpPQkdXU1JFNnJTUnZnYkEreVd3WUlISW95YmFqaDYvSnMzbVk1N0QzUzJ4Ugo3QjNRaWxreER3S0JnUUNRek03QVNXOCtXb2p3a05kTHF3M0F4eHdkcFBXOVdwYmdqTk1zRTVvaWFtNUR0bEI1CkRIdnBhSnN2Z1hhZnpta0o1a0g1M0xySEIwVE5zdm1TZ3VESWFGdnZJS1k3aVo0RGFBMWpYYWZqanRVRFJEVlAKb1JmalhQUE1Nc08zek9RWGJLL3hxbmV6VUdUYXZRekJxRWUyOHFiYW9UbzA2T1BIc2dqbVVCekxoUUtCZ0dwWgpvdFErTGMyTlhWNU9yRDhLeEpVU0Fad0FqVlBnTVdFNjgxVVlxUVZyaHR3M2ZWdzVsWmxCUGI1STIwa3c4eFEvCnYvNEtqRTgzSTVqcE95NFlaSDQxMTUyYllDS29oTHliRjdhVVpvZG12cGx3K3B6aVlUY1dVZ0IwbFdLcHhQNTYKMHhiODd2SnlFd0tPU3UvbTJ1cUt1bVNFRFQyU2pxcVh3eHdWbXVRMUFvR0FVMnFTaU9xK1FFM2RrbEZRRG9oTQptM1pqQUZYclRWYzlIVmtHSG1ZSkZRbjJVaWdMWml4L2ZsdDJXY3c1bmcwV2duNHVqYmdMTzRwRlFyZHk2dlI4CmlmVXU5VjlZQi9TN3VVRndRcEJIOWtoYVp0MG9OTHBzallFSDVaTVFkNU8wMHNQNUU2OTVWZEc4K1U4clpTL1gKSk1JYlI5cldyekpxTTFEWkZjOFRxT009Ci0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
kind: Secret
metadata:
  name: istio-ingressgateway-certs
  namespace: istio-system

---

apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZBekNDQXV1Z0F3SUJBZ0lVVzRCVkV3MDh1V3R1Zkk5c0NicVB2RlROWjdvd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0VURVBNQTBHQTFVRUF3d0dVbTl2ZEVOQk1CNFhEVEkwTVRJeU5ERTVNRFF4TVZvWERUSTFNVEl5TkRFNQpNRFF4TVZvd0VURVBNQTBHQTFVRUF3d0dVbTl2ZEVOQk1JSUNJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBZzhBCk1JSUNDZ0tDQWdFQW9HdnFTMmoxUnU0Q29KbUVpQkdRWmJ1UGUwOGYvZGIzQ2FITlA2cFdkaWZYaXA2QkhLL0oKZ0hqbnNzWElKVEhERHkya1doWnFkSmxXdTRnNzJtd0dKL3BpVktwMmptQVcwMkxPSnFsZG5ObG9vVUtxOFJOTgpsaXdhdmhnZUhGNDRZRm9jT28vMFd3RFQrUjl0ZEI5UmJSUmdpa0cvRkVkTnhBM2JXNTErUXpoTVpMSFM4Q1ZICm1sNjdKUGJGcm14WFBwcUtNZ244UGpyYzFMaXJodkp2Qnd0TE5NbkVVUTZrSDhhKzB2eUpZUkVSaWlaYkl6dkgKYWxiakUxK1YyNU9PbE9wc21LUVpwMnluMVRBZTJDRzR5S2ZjR1oyT1FHdE8vcC95UDNqUjFOa0Y5ZDUybFRaQgovQUtHRWVLb0hKaCtBRkx4VU9OQjRDUk41V0NNenV1OHhRREVxNGgydUdRK3Jad3dZT0xKVXAyYWp2ZUZxSzRNCkpMcVk1MWg1VjdvaVVHazhzR2NMcHZ1WVFIa01vcTdiR0Q2Y3c2SXIrUVc3VmwxaCt1ZjZLSFJpRTRHV3NGYmcKd3BxdnQzN1NzU2FGMDlTVU9QcmVKeUxON00zbkQ5aFBCZHBtTU4wakQ1endqT0ZKTmFMYjVrRGduaWl5aVJZRgppOWpHZ2tHMi9rd3FOdjBDTE9BbDd3VFR2NzhVZTYvYllTWUVhWHc0RE9HOUdYODNaRUhRUWVLVlg2TnZ3QTM3CkpTMXY2bFB3eXNYdUk5cTVrNVZIVnpvajZRdjgxMGZBT0ZPaGxXVVpnUks4dXRZRWlEeEhuY2VwKzFVdVBnS2UKZFV0V3A5eFI3c1dPWUg4UUVFcWs3SXJEUFpiRE1NeVVtT1F6cGxZeTRBN3BnbmgvSDJML3NMTUNBd0VBQWFOVApNRkV3SFFZRFZSME9CQllFRkkrUE92R0ZMeDRsOSs2c3BVUHY0L1BBcTZCY01COEdBMVVkSXdRWU1CYUFGSStQCk92R0ZMeDRsOSs2c3BVUHY0L1BBcTZCY01BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUwKQlFBRGdnSUJBSmd4Nm5WTTlhR1o3TERiS1NySC85VzNtbzdvSUxwOGx1a2o4SGM4Y3lveE9RZ1JYTktFcCtweApwUGNLYlpibWtrWkF6VWxLT2IyOHdESy9GWmNid2FiUXhHNkdaSmpnNldGR01tTzZxbmtsVXYzc1NGemVkVk1aCjl5L3Zqdk1seVFpNWRVWE50YzN6QVNJZ00xSXMzR2lKdmJ2OGIzS212dTVObis1aXo2dm0wNW0yZGZXWTFkc20KY0c1Qmp2Mi94cU1sYmRnQmtVMUVScGtEbXRsN0lBMkdDemRqNHVpOUNmUkNzdHFtY3YrUExEUFA3UkxsNnpUcQo0cjZYSEVLQ0gzZGFXWk00UEwxNzlvTm5kdHFtdGJyTGdKQzRENTlVaFY5RUhuMDI2RVp2QXZoRkRWRkhpVXJjClV5eTJUc3hOSHhqOUtiNC84RC9XczlVb3B0WEJUalBvN0t5QW5sZnhBdCt3VmVTaDdvSktkdk1DenFmbjdManoKdm00N2RWQ2U3Yjc4dFVqRVpGUzdxR3N1SGt0YXVLcTArRGdmcndNYjZvRS9mdDRicFR5Z3B6amVscXd3RE8yaAp6MHpHczBmN3JXNEdPU1d4UjNIUTJkWGdDNG1IV3pWYUNWWFRsengraUd6VEgxRnBJOTJzcWZ3Qll1TUpRYWI4CnJVcTJsNTZHR0lkdmcrdVBqSk0yTldVVHFScDkrMEtBM0Z6dE02RWl5V25QaGRXaDB4UElrZ0hzRFlIRGhlQWIKWk81OWltQ0pXZTViL3l1ejkxMURxU0dKYzRJbks2K0hWRjBWdXl4RFNZRHBXdjdQRkJ1cnVYcFZYZUlwNVpGQQpmK0Vsa1JFMVdiS1hsbXg0VWp6dkNIenJuWmE4aHozcmNyajljQURWWlpUdWV1R1VvSWpECi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
kind: Secret
metadata:
  name: ca-cert
  namespace: istio-system
  
---

apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: main
  namespace: istio-system
spec:
  selector:
    istio: ingressgateway # Use the default Istio ingress gateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*" # Accept requests from any host
      tls:
        httpsRedirect: true # Redirect HTTP to HTTPS
    - port:
        number: 443
        name: https
        protocol: HTTPS
      hosts:
        - "*" # Accept requests from any host
      tls:
        mode: SIMPLE
        serverCertificate: /etc/istio/ingressgateway-certs/tls.crt
        privateKey: /etc/istio/ingressgateway-certs/tls.key
        caCertificates: /etc/istio/ca-cert/ca.crt
